🔹 nftables چیست؟
nftables نسل جدید سیستم فایروال در لینوکس است که جایگزین iptables شده. این ابزار روی netfilter framework کرنل کار می‌کند و وظیفه‌اش کنترل و فیلتر کردن ترافیک شبکه (مثل NAT، فیلتر پکت، مسیریابی و ...) است.

🔑 ویژگی‌های مهم nftables

✅ جایگزین همه ابزارهای قدیمی مثل iptables, ip6tables, arptables, ebtables شده

✅ دستورها کوتاه‌تر و خواناتر از iptables هستند

✅ سرعت و کارایی بالاتر چون قوانین به صورت bytecode داخل کرنل اجرا می‌شوند

✅ انعطاف‌پذیری بیشتر با امکان استفاده از sets (مجموعه آی‌پی یا پورت) و maps

✅ فقط با یک ابزار (nft) همه مدیریت انجام می‌شود

🔹 ۱. ساختار کلی
nftables از سه بخش اصلی تشکیل می‌شه:

Table (جدول) → مثل یک ظرف اصلی برای نگه‌داشتن قوانین.

Chain (زنجیره) → داخل هر جدول چند chain وجود داره که مشخص می‌کنه قوانین کجا اجرا بشن (ورودی، خروجی، فوروارد).

Rule (قانون) → همون دستورات و شرط‌هایی که مشخص می‌کنن با هر پکت چه کار بشه (قبول، رد، تغییر و …).

🔹 ۲. نقاط اتصال (Hooks)
🔹 hook چیه؟
توی nftables، hook یعنی نقطه‌ای از مسیر حرکت پکت‌ها داخل کرنل که می‌تونی اونجا قانون‌هات رو اجرا کنی.

وقتی یه پکت وارد سیستم می‌شه یا ازش خارج می‌شه، مراحل مختلفی رو توی کرنل رد می‌کنه. nftables بهت اجازه می‌ده chain‌هات رو به این مراحل (همون hookها) وصل کنی.

🔑 مهم‌ترین hookها

prerouting → قبل از اینکه کرنل تصمیم بگیره پکت کجا بره (مناسب برای DNAT).

input → وقتی پکت به خود سیستم میاد (مثلاً SSH به همون سرور).

forward → وقتی سیستم نقش روتر داره و پکت باید به یه مقصد دیگه بره.

output → پکت‌هایی که خود سیستم تولید می‌کنه (مثلاً وقتی سرور شما ping می‌فرسته).

postrouting → درست قبل از خروج پکت از سیستم (مناسب برای SNAT یا ماسک‌کردن).

🔹 ۳. اجرای قوانین
وقتی یک پکت وارد سیستم می‌شه:

به جدول مربوط می‌ره.

وارد chain مشخص می‌شه.

قوانین یکی‌یکی بررسی می‌شن.

اولین قانونی که شرایطش درست باشه، روی پکت اعمال می‌شه (مثلاً accept یا drop).

🔹 ۴. انعطاف‌پذیری

می‌تونی چندین جدول و chain بسازی.

می‌تونی از set استفاده کنی (مثلاً یه لیست آی‌پی مجاز درست کنی و به‌جای چند قانون، یک قانون بنویسی).

می‌تونی NAT یا DNAT و SNAT هم باهاش انجام بدی.



فایل پیکربندی

معمولاً پیکربندی nftables توی یه فایل متنی مثل /etc/nftables.conf ذخیره می‌شه.

در nftables، انواع جدول‌ها مشخص می‌کنند که قوانین فایروال روی چه نوع ترافیکی اعمال شوند.

۱. جدول ip

برای ترافیک IPv4 استفاده می‌شود.

می‌توان قوانین فیلتر کردن، NAT، یا مدیریت پورت‌ها روی IPv4 نوشت.

۲. جدول ip6

مخصوص ترافیک IPv6 است.

مشابه جدول ip اما فقط برای آدرس‌های IPv6 کاربرد دارد.

۳. جدول inet

ترکیبی از IPv4 و IPv6 است.

اجازه می‌دهد با یک جدول همزمان روی IPv4 و IPv6 قوانین بنویسیم.

به صرفه‌تر است چون نیاز به دو جدول جداگانه نیست.

۴. جدول arp

برای مدیریت ترافیک ARP استفاده می‌شود.

کاربردش بیشتر در شبکه‌های محلی است که نیاز به کنترل ارتباط IP ↔ MAC دارند.

۵. جدول bridge

برای شبکه‌هایی که از بریج استفاده می‌کنند کاربرد دارد.

می‌توان ترافیک بین کارت‌های شبکه‌ی bridge را کنترل کرد.

۶. جدول netdev

برای اعمال قوانین مستقیم روی کارت شبکه (interface-level) استفاده می‌شود.

برای کنترل ترافیک ورودی و خروجی از سطح سخت‌افزار شبکه کاربرد دارد.

