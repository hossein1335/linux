🔹 nftables چیست؟
nftables نسل جدید سیستم فایروال در لینوکس است که جایگزین iptables شده. این ابزار روی netfilter framework کرنل کار می‌کند و وظیفه‌اش کنترل و فیلتر کردن ترافیک شبکه (مثل NAT، فیلتر پکت، مسیریابی و ...) است.

🔑 ویژگی‌های مهم nftables

✅ جایگزین همه ابزارهای قدیمی مثل iptables, ip6tables, arptables, ebtables شده

✅ دستورها کوتاه‌تر و خواناتر از iptables هستند

✅ سرعت و کارایی بالاتر چون قوانین به صورت bytecode داخل کرنل اجرا می‌شوند

✅ انعطاف‌پذیری بیشتر با امکان استفاده از sets (مجموعه آی‌پی یا پورت) و maps

✅ فقط با یک ابزار (nft) همه مدیریت انجام می‌شود

🔹 ۱. ساختار کلی
nftables از سه بخش اصلی تشکیل می‌شه:

Table (جدول) → مثل یک ظرف اصلی برای نگه‌داشتن قوانین.

Chain (زنجیره) → داخل هر جدول چند chain وجود داره که مشخص می‌کنه قوانین کجا اجرا بشن (ورودی، خروجی، فوروارد).

Rule (قانون) → همون دستورات و شرط‌هایی که مشخص می‌کنن با هر پکت چه کار بشه (قبول، رد، تغییر و …).

🔹 ۲. نقاط اتصال (Hooks)
🔹 hook چیه؟
توی nftables، hook یعنی نقطه‌ای از مسیر حرکت پکت‌ها داخل کرنل که می‌تونی اونجا قانون‌هات رو اجرا کنی.

وقتی یه پکت وارد سیستم می‌شه یا ازش خارج می‌شه، مراحل مختلفی رو توی کرنل رد می‌کنه. nftables بهت اجازه می‌ده chain‌هات رو به این مراحل (همون hookها) وصل کنی.

🔑 مهم‌ترین hookها

prerouting → قبل از اینکه کرنل تصمیم بگیره پکت کجا بره (مناسب برای DNAT).

input → وقتی پکت به خود سیستم میاد (مثلاً SSH به همون سرور).

forward → وقتی سیستم نقش روتر داره و پکت باید به یه مقصد دیگه بره.

output → پکت‌هایی که خود سیستم تولید می‌کنه (مثلاً وقتی سرور شما ping می‌فرسته).

postrouting → درست قبل از خروج پکت از سیستم (مناسب برای SNAT یا ماسک‌کردن).

🔹 ۳. اجرای قوانین
وقتی یک پکت وارد سیستم می‌شه:

به جدول مربوط می‌ره.

وارد chain مشخص می‌شه.

قوانین یکی‌یکی بررسی می‌شن.

اولین قانونی که شرایطش درست باشه، روی پکت اعمال می‌شه (مثلاً accept یا drop).

🔹 ۴. انعطاف‌پذیری

می‌تونی چندین جدول و chain بسازی.

می‌تونی از set استفاده کنی (مثلاً یه لیست آی‌پی مجاز درست کنی و به‌جای چند قانون، یک قانون بنویسی).

می‌تونی NAT یا DNAT و SNAT هم باهاش انجام بدی.



فایل پیکربندی

معمولاً پیکربندی nftables توی یه فایل متنی مثل /etc/nftables.conf ذخیره می‌شه.

در nftables، انواع جدول‌ها مشخص می‌کنند که قوانین فایروال روی چه نوع ترافیکی اعمال شوند.

۱. جدول ip

برای ترافیک IPv4 استفاده می‌شود.

می‌توان قوانین فیلتر کردن، NAT، یا مدیریت پورت‌ها روی IPv4 نوشت.

۲. جدول ip6

مخصوص ترافیک IPv6 است.

مشابه جدول ip اما فقط برای آدرس‌های IPv6 کاربرد دارد.

۳. جدول inet

ترکیبی از IPv4 و IPv6 است.

اجازه می‌دهد با یک جدول همزمان روی IPv4 و IPv6 قوانین بنویسیم.

به صرفه‌تر است چون نیاز به دو جدول جداگانه نیست.

۴. جدول arp

برای مدیریت ترافیک ARP استفاده می‌شود.

کاربردش بیشتر در شبکه‌های محلی است که نیاز به کنترل ارتباط IP ↔ MAC دارند.

۵. جدول bridge

برای شبکه‌هایی که از بریج استفاده می‌کنند کاربرد دارد.

می‌توان ترافیک بین کارت‌های شبکه‌ی bridge را کنترل کرد.

۶. جدول netdev

برای اعمال قوانین مستقیم روی کارت شبکه (interface-level) استفاده می‌شود.

برای کنترل ترافیک ورودی و خروجی از سطح سخت‌افزار شبکه کاربرد دارد.



📌 دستورات پایه در nftables
🔹 ۱. نمایش و مدیریت قوانین
nft list ruleset             # نمایش همه قوانین فعال
nft list tables              # نمایش همه جدول‌ها
nft list chains              # نمایش همه زنجیره‌ها
nft list ruleset -a          # نمایش قوانین به همراه شماره (handle)
nft flush ruleset            # پاک کردن همه قوانین

🔹 ۲. مدیریت جدول‌ها (tables)
nft add table inet mytable   # ساخت جدول جدید (inet یعنی هم IPv4 هم IPv6)
nft list table inet mytable  # نمایش جدول خاص
nft delete table inet mytable # حذف جدول


۲) ساخت جدول جدید
sudo nft add table inet myfilter


توضیح:

sudo — اجرای با دسترسی ریشه.

nft add table — فرمان ساختن یک جدول جدید.

inet — خانواده (family) جدول؛ inet یعنی هم IPv4 و هم IPv6 را پوشش می‌دهد. (گزینه‌های دیگر: ip فقط IPv4، ip6 فقط IPv6، arp و غیره.)

myfilter — نام دلخواهِ جدول. از این نام بعداً برای اضافه کردن chain و rule استفاده می‌کنیم.
نکته:

اگر جدول با همین نام از قبل وجود داشته باشه، خطا می‌دهد. با nft list tables می‌تونی بررسی کنی.

۳) ساخت زنجیره ورودی با سیاست پیش‌فرض "drop"
sudo nft add chain inet myfilter input { type filter hook input priority 0; policy drop; }


توضیح بخش‌به‌بخش:

sudo nft add chain — اضافه کردن یک chain (زنجیره) جدید به جدول.

inet myfilter — اشاره به جدولِ ساخته‌شده (همان family و نام جدول).

input — نامِ زنجیره؛ اینجا ما زنجیرهٔ مربوط به بسته‌هایی که وارد سیستم می‌شوند (incoming) را می‌سازیم.

{ type filter hook input priority 0; policy drop; } — تعریف خصوصیات زنجیره:

type filter → نوع زنجیره برای فیلتر پکت‌ها (معمول‌ترین نوع).

hook input → این زنجیره در مرحلهٔ input کرنل اجرا می‌شود (یعنی وقتی پکت وارد دستگاه می‌شود).

priority 0 → ترتیب اجرا نسبت به سایر hook‌ها؛ عدد صفر مقدار معمول است (مقادیر منفی یا مثبت هم هست برای تنظیم ترتیب دقیق).

policy drop → اقدام پیش‌فرض برای پکت‌هایی که هیچ قانونی آن‌ها را match نکند؛ در اینجا drop (رد و حذف) است.
نکته‌های مهم:

گذاشتن policy drop یعنی تا زمانی که قوانینی ننوشته باشی، همه چیز بلاک می‌شود — اگر قبل از اضافه‌کردن rule برای SSH این را اجرا کنی، ممکن است دسترسی‌ات قطع شود. برای ایمنی معمولاً اول chain را با policy accept می‌سازند، قوانین مهم را اضافه می‌کنند، سپس policy را به drop تغییر می‌دهند.

sudo nft add rule inet myfilter input ip daddr 127.0.0.1 accept
توضیح خط به خط:
sudo → اجرای دستور با دسترسی root

nft add rule → اضافه کردن یک قانون جدید

inet myfilter input → جدول myfilter و زنجیره input (برای بسته‌های ورودی)

ip daddr 127.0.0.1 → شرط: آدرس مقصد IPv4 برابر 127.0.0.1 باشد

accept → اجازه عبور پکت‌ها


۴٫۲ اجازه به ارتباطات موجود (جلسات قبلی) — connection tracking
sudo nft add rule inet myfilter input ct state established,related accept


توضیح:

ct — مخفف connection tracking؛ nftables با کرنل تعامل می‌کند و وضعیت ارتباط‌ها را پیگیری می‌کند.

state established,related — شرط روی وضعیت اتصال:

established = بسته‌ای که بخشی از یک ارتباطِ قبلاً برقرارشده است (مثلاً پاسخ به بسته‌ای که خودت قبلاً فرستادی).

related = بسته‌ای که مربوط به یک ارتباط موجود است اما خودش جدید نیست (مثلاً FTP data، بعضی ICMPهای مرتبط).

accept — اجازه دادن به این بسته‌ها.
چرا لازم است:

بدون این قاعده، پاسخ‌هایی که از سمت کلاینت یا سرور می‌آیند (پکت‌های مربوط به اتصال‌هایی که خود سرور آغاز کرده یا پاسخ به درخواست‌ها) ممکن است بسته شوند. معمولاً این قاعده را خیلی بالا (اوّل) می‌گذاریم تا ارتباط‌های برقرارشده بدون مانع ادامه پیدا کنند.

۴٫۳ باز کردن پورت ۲۲ (SSH)
sudo nft add rule inet myfilter input tcp dport 22 accept


توضیح:

tcp — پروتکل موردنظر؛ اینجا TCP (پروتکلِ SSH).

dport 22 — شرط: destination port برابر ۲۲ باشد (یعنی مقصد پکت پورت ۲۲ روی این ماشین).

accept — اجازهٔ ورود این پکت.
نکتهٔ تکمیلی (پیشنهادی):

بهتر است همراه با ct state محدودش کنی تا دقیق‌تر باشه:

sudo nft add rule inet myfilter input tcp dport 22 ct state new,established accept


اینطوری فقط برای اتصال‌های جدید یا اتصال‌های برقرارشده اجازه داده می‌شود (کمی ایمن‌تر و منطقی‌تر).

۵) تست و نمایش قوانین
sudo nft list ruleset


توضیح:

nft list ruleset — نمایشِ کاملِ مجموعهٔ قوانین به صورت خوانا: tables، chains و rules.
چیزهایی که می‌بینی:

ساختار در خروجی شبیهِ این خواهد بود:

table inet myfilter {
    chain input {
        type filter hook input priority 0; policy drop;
        iif "lo" accept
        ct state established,related accept
        tcp dport 22 accept
    }
}


توضیح عناصر خروجی:

table inet myfilter → جدول ساخته شده.

chain input { ... policy drop; } → زنجیره و policy پیش‌فرض.

خطوط بعدی → هر rule که اضافه کرده‌ای؛ ترتیب قوانین مهم است (از بالا به پایین بررسی می‌شوند).

نکته اضافی:

اگر می‌خواهی شناسه (handle) قوانین را ببینی تا بعداً براساس آن حذف کنی، از sudo nft list ruleset -a استفاده کن.

۶) ذخیره قوانین
sudo sh -c "nft list ruleset > /etc/nftables.conf"
sudo systemctl enable nftables
sudo systemctl restart nftables


توضیح مرحله‌به‌مرحله:

sudo sh -c "nft list ruleset > /etc/nftables.conf"

nft list ruleset خروجی قوانین را چاپ می‌کند.

> /etc/nftables.conf آن خروجی را در فایل /etc/nftables.conf ذخیره می‌کند.

دلیل استفاده از sh -c با sudo این است که redirection (>) توسط شلِ کاربر انجام می‌شود و اگر فقط sudo nft list ruleset > /etc/nftables.conf بنویسی، ممکن است کاربر نتواند فایلِ /etc را بنویسد. sudo sh -c باعث می‌شود کل خط تحتِ دسترسی ریشه اجرا شود.

جایگزین ایمن‌تر: sudo nft list ruleset | sudo tee /etc/nftables.conf تا نیازی به sh -c نباشد.

sudo systemctl enable nftables

فعال کردن سرویس nftables در بوت؛ به این معنی که هنگام راه‌اندازی مجدد سیستم، فایل /etc/nftables.conf بارگذاری شود.

sudo systemctl restart nftables

راه‌اندازی مجدد سرویس تا تنظیمات جدید (از فایل یا حافظه) اعمال شوند. بعد از ری‌استارت، می‌توانی دوباره sudo nft list ruleset را چک کنی تا مطمئن شوی تغییرات پابرجا هستند.
